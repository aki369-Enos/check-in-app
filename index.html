/**
 * 1. 處理「讀取」請求 (GET)
 */
function doGet() {
  const data = getDashboardData();
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .addHeader("Access-Control-Allow-Origin", "*");
}

/**
 * 2. 處理「寫入」請求 (POST)
 */
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const result = updateCheckInStatus(params.name, params.isChecked);
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader("Access-Control-Allow-Origin", "*");
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: err.message }))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader("Access-Control-Allow-Origin", "*");
  }
}

/**
 * 3. 處理 CORS (OPTIONS)
 */
function doOptions(e) {
  return ContentService.createTextOutput("")
    .setMimeType(ContentService.MimeType.TEXT)
    .addHeader("Access-Control-Allow-Origin", "*")
    .addHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
    .addHeader("Access-Control-Allow-Headers", "Content-Type");
}

/**
 * 4. 取得儀表板資料邏輯
 */
function getDashboardData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashboardSheet = ss.getSheetByName('聚餐儀表板'); //
  const employeeSheet = ss.getSheetByName('員工資料庫'); //

  const arrivedCount = dashboardSheet.getRange('A2').getValue() || 0;
  const notArrivedCount = dashboardSheet.getRange('B2').getValue() || 0;

  // 取得員工名單與狀態 (假設 D 欄是姓名, A 欄是勾選框)
  const lastRow = employeeSheet.getLastRow();
  const names = employeeSheet.getRange(2, 4, lastRow - 1, 1).getValues(); // D 欄
  const checks = employeeSheet.getRange(2, 1, lastRow - 1, 1).getValues(); // A 欄

  const employeeList = names.map((row, index) => {
    return {
      name: row[0],
      isChecked: checks[index][0] === true || checks[index][0] === '已到'
    };
  });

  return {
    arrivedCount: arrivedCount,
    notArrivedCount: notArrivedCount,
    employeeList: employeeList
  };
}

/**
 * 5. 更新勾選狀態邏輯
 */
function updateCheckInStatus(name, isChecked) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const employeeSheet = ss.getSheetByName('員工資料庫');
  const lastRow = employeeSheet.getLastRow();
  const names = employeeSheet.getRange(2, 4, lastRow - 1, 1).getValues();

  for (let i = 0; i < names.length; i++) {
    if (names[i][0] === name) {
      // 在 A 欄寫入勾選或取消
      employeeSheet.getRange(i + 2, 1).setValue(isChecked);
      return { status: 'success' };
    }
  }
  return { status: 'not_found' };
}
